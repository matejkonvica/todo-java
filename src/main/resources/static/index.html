<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>TODO Application</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
        body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; }
        .wrap { max-width: 820px; margin: 40px auto; padding: 0 14px; }
        .card { background:#fff; padding:24px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.10); }
        h1 { margin:0 0 12px 0; text-align:center; }
        .muted { color:#666; font-size:14px; }
        .row { display:flex; gap:10px; flex-wrap:wrap; }
        .row > * { flex:1; min-width: 160px; }
        input, select, button { font-size:16px; padding:10px; border-radius:8px; border:1px solid #cfd6dd; }
        button { background:#fff; cursor:pointer; }
        button:hover { background:#f6f8fa; }
        .status { margin-top: 12px; white-space: pre-wrap; font-size: 14px; }
        .status.error { color: #b00020; }
        .topbar { display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom: 14px; }
        .pill { font-size: 12px; padding: 3px 8px; border-radius: 999px; border:1px solid #d9e2ec; background:#f6f8fa; }
        ul { list-style:none; padding:0; margin: 14px 0 0 0; border-top:1px solid #eee; }
        li { display:flex; gap:10px; align-items:center; justify-content:space-between; padding:10px 6px; border-bottom:1px solid #eee; }
        .title { flex: 1; }
        .actions { display:flex; gap:8px; align-items:center; }
        .login { max-width: 520px; margin: 90px auto; }
        .center { text-align:center; }
        .link { color:#0b57d0; cursor:pointer; text-decoration:underline; }
    </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen" class="wrap login" style="display:none;">
    <div class="card">
        <h1>üîê Login</h1>
        <p class="muted center">
            Enter your API token (the value from <span class="pill">todo.auth.api-key</span> in <span class="pill">application.yml</span>).
        </p>

        <div class="row">
            <input type="password" id="login-token" placeholder="Token (without 'Bearer ')" />
            <button id="login-btn">Continue</button>
        </div>

        <div class="status" id="login-status"></div>
        <p class="muted center" style="margin-top:14px;">
            Tip: You can change the token later via <span class="link" id="logout-link">logout</span>.
        </p>
    </div>
</div>

<!-- APP SCREEN -->
<div id="app-screen" class="wrap" style="display:none;">
    <div class="card">
        <h1>üìù TODO List</h1>

        <div class="topbar">
            <div class="muted">
                Auth: <span class="pill" id="auth-indicator">token set</span>
            </div>
            <button id="logout-btn">Logout</button>
        </div>

        <!-- CREATE -->
        <form id="todo-form" class="row" autocomplete="off">
            <input type="text" id="title" placeholder="New task title..." required />
            <button type="submit">Add</button>
        </form>

        <div class="status" id="app-status"></div>

        <ul id="todo-list"></ul>
    </div>
</div>

<script>
    const API_URL = "/todo";
    const TOKEN_KEY = "todo_api_token";
    const STATUSES = ["NOT_FINISHED", "ONGOING", "FINISHED"];

    function getToken() { return localStorage.getItem(TOKEN_KEY) || ""; }
    function setToken(t) { localStorage.setItem(TOKEN_KEY, t); }
    function clearToken() { localStorage.removeItem(TOKEN_KEY); }

    function setStatus(elId, msg, isError=false) {
        const el = document.getElementById(elId);
        el.textContent = msg || "";
        el.classList.toggle("error", !!isError);
    }

    function show(screen) {
        document.getElementById("login-screen").style.display = (screen === "login") ? "block" : "none";
        document.getElementById("app-screen").style.display = (screen === "app") ? "block" : "none";
    }

    function authHeaders(extra = {}) {
        const token = getToken().trim();
        if (!token) return extra;
        return Object.assign({}, extra, { "Authorization": "Bearer " + token });
    }

    async function fetchJson(url, options = {}) {
        const resp = await fetch(url, options);
        if (!resp.ok) {
            let msg = `${resp.status} ${resp.statusText}`;
            try {
                const err = await resp.json();
                if (err && err.message) msg = `${msg}: ${err.message}`;
            } catch (_) {}
            throw new Error(msg);
        }
        if (resp.status === 204) return null;
        return await resp.json();
    }

    function statusLabel(s) {
        if (s === "NOT_FINISHED") return "Not finished";
        if (s === "ONGOING") return "Ongoing";
        if (s === "FINISHED") return "Finished";
        return s;
    }

    function renderTodos(todos) {
        const list = document.getElementById("todo-list");
        list.innerHTML = "";

        todos.forEach(todo => {
            const li = document.createElement("li");

            const title = document.createElement("div");
            title.className = "title";
            title.innerHTML = `<span class="pill">#${todo.id}</span> ${escapeHtml(todo.title)}`;

            const actions = document.createElement("div");
            actions.className = "actions";

            const sel = document.createElement("select");
            STATUSES.forEach(s => {
                const opt = document.createElement("option");
                opt.value = s;
                opt.textContent = statusLabel(s);
                sel.appendChild(opt);
            });
            sel.value = todo.status || "NOT_FINISHED";
            sel.onchange = () => updateStatus(todo, sel.value);

            const editBtn = document.createElement("button");
            editBtn.type = "button";
            editBtn.textContent = "‚úèÔ∏è";
            editBtn.title = "Edit title";
            editBtn.onclick = () => editTodo(todo);

            const delBtn = document.createElement("button");
            delBtn.type = "button";
            delBtn.textContent = "üóëÔ∏è";
            delBtn.title = "Delete";
            delBtn.onclick = () => deleteTodo(todo.id);

            actions.appendChild(sel);
            actions.appendChild(editBtn);
            actions.appendChild(delBtn);

            li.appendChild(title);
            li.appendChild(actions);
            list.appendChild(li);
        });
    }

    function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text ?? "";
        return div.innerHTML;
    }

    async function loadTodos() {
        setStatus("app-status", "");
        try {
            const todos = await fetchJson(API_URL, { headers: authHeaders() });
            renderTodos(Array.isArray(todos) ? todos : []);
        } catch (e) {
            setStatus("app-status", "Failed to load TODOs: " + e.message, true);
            if (String(e.message).startsWith("401")) {
                clearToken();
                boot();
            }
        }
    }

    async function addTodo(title) {
        setStatus("app-status", "");
        try {
            await fetchJson(API_URL, {
                method: "POST",
                headers: authHeaders({ "Content-Type": "application/json" }),
                body: JSON.stringify({ title: title })
            });
            await loadTodos();
        } catch (e) {
            setStatus("app-status", "Failed to add TODO: " + e.message, true);
        }
    }

    async function updateStatus(todo, newStatus) {
        setStatus("app-status", "");
        try {
            await fetchJson(`${API_URL}/${todo.id}`, {
                method: "PUT",
                headers: authHeaders({ "Content-Type": "application/json" }),
                body: JSON.stringify({ title: todo.title, status: newStatus })
            });
            await loadTodos();
        } catch (e) {
            setStatus("app-status", "Failed to update status: " + e.message, true);
        }
    }

    async function editTodo(todo) {
        const newTitle = prompt("Edit title:", todo.title);
        if (newTitle === null) return;
        const trimmed = newTitle.trim();
        if (!trimmed) { alert("Title cannot be empty."); return; }

        setStatus("app-status", "");
        try {
            await fetchJson(`${API_URL}/${todo.id}`, {
                method: "PUT",
                headers: authHeaders({ "Content-Type": "application/json" }),
                body: JSON.stringify({ title: trimmed, status: todo.status || "NOT_FINISHED" })
            });
            await loadTodos();
        } catch (e) {
            setStatus("app-status", "Failed to edit TODO: " + e.message, true);
        }
    }

    async function deleteTodo(id) {
        if (!confirm("Delete this TODO?")) return;
        setStatus("app-status", "");
        try {
            await fetchJson(`${API_URL}/${id}`, {
                method: "DELETE",
                headers: authHeaders()
            });
            await loadTodos();
        } catch (e) {
            setStatus("app-status", "Failed to delete TODO: " + e.message, true);
        }
    }

    async function tryLogin(token) {
        setStatus("login-status", "");
        setToken(token);

        try {
            await fetchJson(API_URL, { headers: authHeaders() });
            show("app");
            await loadTodos();
        } catch (e) {
            clearToken();
            setStatus("login-status", "Login failed: " + e.message, true);
        }
    }

    function boot() {
        show("login");

        const t = getToken().trim();
        if (t) document.getElementById("login-token").value = t;
    }

    document.getElementById("login-btn").addEventListener("click", () => {
        const token = document.getElementById("login-token").value.trim();
        if (!token) { setStatus("login-status", "Please enter token.", true); return; }
        tryLogin(token);
    });

    document.getElementById("logout-btn").addEventListener("click", () => {
        clearToken();
        document.getElementById("login-token").value = "";
        setStatus("login-status", "");
        boot();
    });

    document.getElementById("logout-link").addEventListener("click", () => {
        clearToken();
        document.getElementById("login-token").value = "";
        setStatus("login-status", "");
        boot();
    });

    document.getElementById("todo-form").addEventListener("submit", (e) => {
        e.preventDefault();
        const input = document.getElementById("title");
        const title = input.value.trim();
        if (!title) return;
        input.value = "";
        addTodo(title);
    });

    window.addEventListener("load", boot);
</script>
</body>
</html>
